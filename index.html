<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SchedMaster â€” Web & SMS-Based Class Scheduling System</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg: 248 249 251; --card: 255 255 255; --ink: 15 23 42; }
    html, body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; }
    .glass { backdrop-filter: blur(8px); background: rgba(255,255,255,0.65); }
    .scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
    .scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 999px; }
    /* Ensure subject blocks are above grid lines */
    .subject-block {
    position: absolute;
    z-index: 10; /* on top of grid lines */
    text-align: center;
    margin: 2px 0;  /* small vertical gap */
    padding: 4px 6px; /* more padding for easier reading */
    border-radius: 1rem; /* make it rounder */
    font-size: 0.875rem; /* slightly bigger */
  }


    /* Keep small padding so grid lines are visible around the block */
    [data-col] {
      position: relative;
      padding: 0.5px;
      overflow: visible; /* Add this */
    }

    .day-separator {
  border-right: 1px solid rgba(156,163,175,0.5); /* light gray */
  position: relative;
  height: 100%;
}

    /* Horizontal lines for each hour */
    .timetable-row {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      border-bottom: 3px solid rgba(156,163,175,0.3); /* light gray line */
}

    /* Vertical lines between days */
    [data-col]:not(:last-child) {
      border-right: 3px solid rgba(156,163,175,0.3); /* light gray */
}

/* --- Mobile Timetable improvements --- */
@media (max-width: 768px) {
  #timetable {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Grid min width so days donâ€™t squash too much */
  #timetable > div {
    min-width: 550px; /* 5 days + time column */
  }

  /* Slightly smaller blocks on phones */
  .subject-block {
    font-size: 0.75rem; /* ~12px */
    padding: 2px 4px;
    border-radius: 0.75rem;
  }
}

/* --- Extra small devices (â‰¤ 400px) --- */
@media (max-width: 400px) {
  html { font-size: 13px; }
  header h1 { font-size: 0.85rem; }
  .tab-panel { padding: 0.25rem; }

  #timetable > div {
    min-width: 480px; /* narrower timetable */
  }

  .subject-block {
    font-size: 0.7rem;
    padding: 2px;
  }
}

/* --- Mobile Nav tweaks --- */
@media (max-width: 640px) {
  #mobileBottomNav button {
    font-size: 0.75rem;
    padding: 0.4rem 0.25rem;
  }
}

    /* Mobile adjustments */
  @media (max-width: 640px) {
    input, select, textarea, button {
      width: 100%;
    }
  }
  html { font-size: 15px; }
  body { font-size: 15px; }

  header h1 { font-size: 1rem; }
  .tab-panel { padding: 0.5rem; }

  input, select, textarea, button { font-size: 0.9rem; }

  /* Tables scroll horizontally */
  #timetable, #teacher-table {
    max-height: 640px;
    overflow-y: auto;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  #timetable div[data-col] {
    position: relative;
    min-height: 64px;
  }

  
  /* Mobile Bottom Nav */
  #mobileBottomNav {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    border-top: 1px solid #16a34a;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: env(safe-area-inset-bottom, 0.5rem) 0;
    z-index: 50;
    box-shadow: 0 -1px 5px rgba(0,0,0,0.1);
  }

  #mobileBottomNav button {
    flex: 1;
    text-align: center;
    padding: 0.5rem 0.25rem;
    font-size: 0.875rem;
    background: none;
    border: none;
    color: #16a34a;
    font-weight: 500;
  }

  #mobileBottomNav button.active {
    color: white;
    background-color: #16a34a;
    border-radius: 0.5rem;
  }

/* Very small devices */
@media (max-width: 375px) {
  html { font-size: 13px; }
  header h1 { font-size: 0.9rem; }

#timetable div[data-col] div {
  font-size: 0.7rem;
  padding: 0.25rem;
}

}



  </style>
</head>
<body class="bg-green-50 text-green-800">
  <!-- Header -->
  <header class="sticky top-0 z-40 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
         <div class="h-14 w-14 flex items-center justify-center">
          <!--<img src="assets/FEU LOGO.png" class="h-12 w-12 sm:h-14 sm:w-14 object-contain"> [IF U WANT LOGO FOR FEU]-->
          </div>
        <h1 class="text-lg sm:text-xl font-semibold">SchedMaster â€” Web & SMS</h1>
      </div>
      <nav class="hidden sm:flex items-center gap-2">
        <button data-tab="student" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium hover:bg-green-500">Student View</button>
        <button data-tab="teacher" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium hover:bg-green-500">Teacher Console</button>
        <button data-tab="sms" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium hover:bg-green-500">SMS Center</button>
        <button data-tab="settings" class="tab-btn px-3 py-2 rounded-xl text-sm font-medium hover:bg-green-500">Settings</button>
      </nav>
      <button id="menuBtn" class="sm:hidden p-2 rounded-lg hover:bg-green-500" aria-label="Open menu">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
      </button>
    </div>
    <div id="mobileNav" class="sm:hidden hidden border-t border-green-600">
      <div class="px-4 py-2 flex flex-col">
        <button data-tab="student" class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-green-500">Student View</button>
        <button data-tab="teacher" class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-green-500">Teacher Console</button>
        <button data-tab="sms" class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-green-500">SMS Center</button>
        <button data-tab="settings" class="tab-btn text-left px-3 py-2 rounded-lg hover:bg-green-500">Settings</button>
      </div>
    </div>
  </header>
  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Hero -->
    <section class="mb-8">
      <div class="rounded-3xl p-6 sm:p-8 bg-gradient-to-tr from-green-700 to-green-800 text-white shadow-lg">
        <h2 class="text-2xl FEU:text-3xl font-semibold">Inclusive class scheduling for every student</h2>
        <p class="mt-2 text-white/90 max-w-3xl">SchedMaster runs on the web and delivers weekly schedules via SMS for learners without internet access. Teachers create timetables; students check online or receive SMS updates automatically.</p>
        <div class="mt-4 flex flex-wrap gap-2">
          <span class="px-3 py-1 rounded-full bg-white/20 text-sm">Web-based</span>
          <span class="px-3 py-1 rounded-full bg-white/20 text-sm">SMS delivery</span>
          <span class="px-3 py-1 rounded-full bg-white/20 text-sm">Conflict detection</span>
          <span class="px-3 py-1 rounded-full bg-white/20 text-sm">Local storage demo</span>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <section>
      <!-- Student View -->
      <div data-panel="student" class="tab-panel">
        <div class="grid md:grid-cols-3 gap-6">
          <div class="md:col-span-1">
            <div class="bg-white rounded-2xl shadow p-5">
              <h3 class="font-semibold text-lg">Find your schedule</h3>
              <p class="text-sm text-green-600 mt-1">Choose your grade and strand/section to view the week.</p>
              <div class="mt-4 space-y-3">
                <label class="text-sm font-medium">Grade Level</label>
                <select id="sv-grade" class="w-full rounded-xl border-green-300 focus:ring-2 focus:ring-green-500">
                  <option value="11">Grade 11</option>
                  <option value="12">Grade 12</option>
                </select>
                <label class="text-sm font-medium">Strand</label>
                <input id="sv-strand" placeholder="e.g., STEM-IT, ABM" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500"/>
                <label class="text-sm font-medium">Section</label>
                <input id="sv-section" placeholder="e.g., SIMPLICITY, ALTURISM" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500"/>
                <button id="sv-load" class="w-full mt-2 inline-flex items-center justify-center gap-2 rounded-xl bg-green-700 hover:bg-green-700 text-white px-4 py-2.5 font-medium">
                  Load Week
                </button>
              </div>
              <hr class="my-5"/>
              <h4 class="font-semibold">SMS subscription</h4>
              <p class="text-sm text-slate-600">Opt in to receive weekly schedules via SMS.</p>
              <div class="mt-3 space-y-3">
                <input id="sv-phone" placeholder="e.g., 09XXXXXXXXX" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500"/>
                <button id="sv-sub" class="w-full rounded-xl bg-green-700 hover:bg-green-700 text-white px-4 py-2 font-medium">Subscribe via SMS</button>
                <p id="sv-sub-msg" class="text-xs text-slate-600"></p>
              </div>
            </div>
          </div>
          <div class="md:col-span-2">
            <div class="bg-white rounded-2xl shadow p-5">
              <div class="flex items-center justify-between gap-3">
                <h3 class="font-semibold text-lg">Weekly timetable</h3>
                <button id="export-sms" class="rounded-xl border border-slate-300 px-3 py-2 text-sm hover:bg-slate-50">Export as SMS Text</button>
              </div>
              <div id="timetable" class="mt-4 overflow-auto scrollbar">
                <!-- Grid injected by JS -->
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Teacher Console -->
      <div data-panel="teacher" class="tab-panel hidden">
        <div class="grid lg:grid-cols-3 gap-6">
          <div class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow p-5">
              <h3 class="font-semibold text-lg">Create class entry</h3>
              <p class="text-sm text-slate-600">Add a subject for a specific day and time.</p>
              <form id="class-form" class="mt-4 grid grid-cols-1 gap-3">
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-medium">Grade</label>
                    <select name="grade" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500">
                      <option value="11">11</option>
                      <option value="12">12</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Strand</label>
                    <input name="strand" placeholder="STEM/ABM/HUMSS..." class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" required />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-medium">Section</label>
                    <input name="section" placeholder="A/B/1..." class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" required />
                  </div>
                  <div>
                    <label class="text-sm font-medium">Teacher</label>
                    <input name="teacher" placeholder="Mr./Ms. Name" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" />
                  </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <div>
                    <label class="text-sm font-medium">Subject</label>
                    <input name="subject" placeholder="e.g., Math" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" required />
                  </div>
                  <div>
                    <label class="text-sm font-medium">Room</label>
                    <input name="room" placeholder="e.g., 201" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" />
                  </div>
                </div>
                <div class="grid grid-cols-3 gap-3">
                  <div>
                    <label class="text-sm font-medium">Day</label>
                    <select name="day" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500">
                      <option>Mon</option><option>Tue</option><option>Wed</option><option>Thu</option><option>Fri</option>
                    </select>
                  </div>
                  <div>
                    <label class="text-sm font-medium">Start</label>
                    <input type="time" name="start" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" required />
                  </div>
                  <div>
                    <label class="text-sm font-medium">End</label>
                    <input type="time" name="end" class="w-full rounded-xl border-slate-300 focus:ring-2 focus:ring-green-500" required />
                  </div>
                </div>
                <button class="mt-1 rounded-xl bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 font-medium">Add Class</button>
                <p id="conflict-msg" class="text-sm mt-1"></p>
              </form>
            </div>
          </div>
          <div class="lg:col-span-2">
            <div class="bg-white rounded-2xl shadow p-5">
              <div class="flex items-center justify-between">
                <h3 class="font-semibold text-lg">Current timetable (selected cohort)</h3>
                <div class="flex gap-2 items-center">
                  <select id="tc-grade" class="rounded-xl border-slate-300">
                    <option value="11">11</option>
                    <option value="12">12</option>
                  </select>
                  <input id="tc-strand" placeholder="Strand" class="rounded-xl border-slate-300"/>
                  <input id="tc-section" placeholder="Section" class="rounded-xl border-slate-300"/>
                  <button id="tc-load" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Load</button>
                </div>
              </div>
              <div id="teacher-table" class="mt-4 overflow-auto scrollbar"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- SMS Center -->
      <div data-panel="sms" class="tab-panel hidden">
        <div class="grid md:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl shadow p-5">
            <h3 class="font-semibold text-lg">Subscribers</h3>
            <p class="text-sm text-slate-600">Manage phone numbers subscribed to weekly SMS schedules.</p>
            <div id="subs-list" class="mt-4 flex flex-col gap-2"></div>
          </div>
          <div class="bg-white rounded-2xl shadow p-5">
            <h3 class="font-semibold text-lg">Compose preview</h3>
            <p class="text-sm text-slate-600">Generate the SMS text for a specific student cohort.</p>
            <div class="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-3">
              <select id="sms-grade" class="rounded-xl border-slate-300">
                <option value="11">11</option>
                <option value="12">12</option>
              </select>
              <input id="sms-strand" placeholder="Strand" class="rounded-xl border-slate-300"/>
              <input id="sms-section" placeholder="Section" class="rounded-xl border-slate-300"/>
            </div>
            <button id="sms-generate" class="mt-3 rounded-xl bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 font-medium">
              Generate SMS Text
            </button>
            <textarea id="sms-preview" rows="10" class="mt-3 w-full rounded-xl border-slate-300" placeholder="Generated SMS will appear here..."></textarea>
            <div class="mt-3 flex gap-2">
              <button id="sms-send" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Simulate Send</button>
              <span id="sms-status" class="text-sm"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings -->
      <div data-panel="settings" class="tab-panel hidden">
        <div class="bg-white rounded-2xl shadow p-5">
          <h3 class="font-semibold text-lg">System settings</h3>
          <p class="text-sm text-slate-600">Demo options stored in your browser (no backend required).</p>
          <div class="mt-4 grid sm:grid-cols-2 gap-6">
            <div>
              <h4 class="font-medium">School identity</h4>
              <div class="mt-2 space-y-2">
                <input id="school-name" placeholder="School name" class="w-full rounded-xl border-slate-300"/>
                <input id="sms-sender" placeholder="SMS Sender (e.g., SchedMaster)" class="w-full rounded-xl border-slate-300"/>
                <button id="save-settings" class="rounded-xl bg-green-500 hover:bg-green-800 text-white px-4 py-2">Save</button>
              </div>
            </div>
            <div>
              <h4 class="font-medium">Data management</h4>
              <div class="mt-2 flex flex-wrap gap-2">
                <button id="seed-demo" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Seed demo data</button>
                <button id="clear-data" class="rounded-xl border px-3 py-2 text-sm hover:bg-rose-50 border-rose-200 text-rose-700">Clear all data</button>
              </div>
              <p class="text-xs text-slate-500 mt-2">This demo uses LocalStorage. For production, connect to your database and an SMS gateway (e.g., telco or API provider).</p>
            </div>
          </div>
        </div>
      </div>

    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-10">
    <p class="text-center text-sm text-slate-500">Â© <span id="year"></span> SchedMaster Demo â€” Web & SMS Scheduler</p>
  </footer>

  <script>
    // ---------- Utilities ----------
    const $ = (sel, ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel, ctx=document)=>Array.from(ctx.querySelectorAll(sel));
    const store = {
      read(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } },
      write(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
    };

    const KEYS = {
      classes: 'sm.classes', // array of class entries
      subs: 'sm.subscribers', // array of {phone, grade, strand, section}
      settings: 'sm.settings' // {schoolName, smsSender}
    };

    const DAYS = ['Mon','Tue','Wed','Thu','Fri'];

    function to12Hour(timeStr) {
      let [h, m] = timeStr.split(":").map(Number);
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12 || 12; // convert 0 -> 12, 13 -> 1
      return `${h}:${m.toString().padStart(2,"0")} ${ampm}`;
    }
    function overlap(aStart,aEnd,bStart,bEnd){ return Math.max(aStart,bStart) < Math.min(aEnd,bEnd); }
    function timeToMinutes(t){ const [h, m] = t.split(':').map(Number); return h*60+m; }

    function cohortKey({grade, strand, section}){ return `${String(grade)}|${(strand||'').trim().toUpperCase()}|${(section||'').trim().toUpperCase()}`; }

    function fetchClasses(filter){
      const all = store.read(KEYS.classes, []);
      if(!filter) return all;
      const key = cohortKey(filter);
      return all.filter(c => cohortKey(c) === key);
    }

    function fetchClassesWithIndex(filter){
      const all = store.read(KEYS.classes, []);
      const key = cohortKey(filter);
      return all.map((c, i)=>({ ...c, _i:i })).filter(c => cohortKey(c) === key);
    }

    function addClass(entry){
      const list = store.read(KEYS.classes, []);
      list.push(entry);
      store.write(KEYS.classes, list);
    }

    function normalizeCohort(obj){
      return {
        grade: String(obj.grade),
        strand: (obj.strand||'').trim().toUpperCase(),
        section: (obj.section||'').trim().toUpperCase(),
        day: obj.day ? String(obj.day).trim().slice(0,3) : undefined
      };
    }

    function conflictFor(entry){
      const sameCohort = fetchClasses(entry);
      const s = timeToMinutes(entry.start);
      const e = timeToMinutes(entry.end);
      const found = sameCohort.find(c => c.day===entry.day && overlap(s,e,timeToMinutes(c.start), timeToMinutes(c.end)));
      return found || null;
    }

    // ---------- Timetable Grid (Student) ----------
    function renderGrid(target, classes) {
  const grid = document.createElement('div');

  grid.className = 'w-full overflow-x-auto min-w-[550px]';

  grid.className = 'w-full overflow-x-auto';
  
  
  grid.innerHTML = `
    <!-- Header -->
    <div class="grid grid-cols-6 text-sm font-semibold text-slate-600 min-w-[360px]">
      <div></div>
      ${DAYS.map(d => `<div class="p-1 text-center ${d !== 'Fri' ? 'day-separator' : ''}">${d}</div>`).join('')}
    </div>

    <!-- Hour rows -->
    ${Array.from({ length: 10 }).map((_, i) => {
      const hour = 7 + i;
      return `
        <div class="timetable-row min-h-[60px]">
          <div class="p-1 text-xs text-slate-500">${to12Hour(hour + ":00")}</div>
          ${DAYS.map(d => `<div class="p-0.5 relative" data-col="${d}" data-hour="${hour}"></div>`).join('')}
        </div>
      `;
    }).join('')}
  `;

  target.innerHTML = '';
  target.appendChild(grid);

  // Add classes
  classes.forEach(c => {
    const [startHour, startMin] = c.start.split(':').map(Number);
    const [endHour, endMin] = c.end.split(':').map(Number);
    const startCell = grid.querySelector(`[data-col='${c.day}'][data-hour='${startHour}']`);
    if (!startCell) return;

    const cellHeight = 60;
    const startOffset = (startMin / 60) * cellHeight;
    const durationHours = (endHour + endMin/60) - (startHour + startMin/60);
    const blockHeight = Math.max(cellHeight * 0.5, durationHours * cellHeight);

    const subj = document.createElement('div');
    subj.className = 'absolute left-1 right-1 top-0 bg-green-700 text-white rounded-3xl px-2 py-1.5 text-sm font-semibold text-center flex items-center justify-center shadow border border-green-800 hover:scale-110 hover:shadow-3xl transition-transform transition-shadow duration-300 ease-in-out cursor-pointer';
    subj.style.top = `${startOffset}px`;
    subj.style.height = `${blockHeight}px`;
    subj.innerText = c.subject;

    // Hover popup
const popup = document.createElement('div');
popup.className = 'absolute top-0 bg-white text-green-700 border border-green-800 rounded shadow p-2 text-xs hidden z-50 w-48';
popup.innerHTML = `
  <div class="font-bold">${c.subject}</div>
  <div>Time: ${to12Hour(c.start)} â€“ ${to12Hour(c.end)}</div>
  <div>Room: ${c.room || 'N/A'}</div>
  <div>Teacher: ${c.teacher || 'N/A'}</div>
`;

// default â†’ show popup on the right
popup.style.left = "100%";
popup.style.marginLeft = "0.25rem";

// if Thursday or Friday â†’ flip popup to the left
if (c.day === "Thu" || c.day === "Fri") {
  popup.style.left = "auto";
  popup.style.right = "100%";
  popup.style.marginLeft = "0";
  popup.style.marginRight = "0.25rem";
}

subj.addEventListener('mouseenter', () => popup.classList.remove('hidden'));
subj.addEventListener('mouseleave', () => popup.classList.add('hidden'));

startCell.appendChild(subj);
startCell.appendChild(popup);

  });
}



    // ---------- Teacher Table ----------
    function renderTeacherTable(target, listWithIndex, filter){
      const rows = listWithIndex
        .slice()
        .sort((a,b)=> (DAYS.indexOf(a.day)-DAYS.indexOf(b.day)) || (timeToMinutes(a.start)-timeToMinutes(b.start)));

      const empty = rows.length===0
        ? `<div class="p-4 text-sm text-slate-500 border rounded-xl">No classes for G${filter.grade} ${filter.strand}-${filter.section}.</div>`
        : '';

      const table = document.createElement('div');
      table.className = 'w-full overflow-x-auto';
      table.innerHTML = `
        ${empty}
        ${rows.map((c, idx)=>`
          <div class="grid grid-cols-12 items-center border rounded-xl mb-2">
            <div class="col-span-3 px-3 py-2">
              <div class="text-sm font-medium">${c.subject}</div>
              <div class="text-xs text-slate-600">${c.teacher || ''}</div>
            </div>
            <div class="col-span-3 px-3 py-2 text-sm">${c.day} â€¢ ${to12Hour(c.start)}â€“${to12Hour(c.end)}</div>
            <div class="col-span-3 px-3 py-2 text-sm">${c.room ? 'Room '+c.room : ''}</div>
            <div class="col-span-2 px-3 py-2 text-xs text-slate-500">G${c.grade} ${c.strand}-${c.section}</div>
            <div class="col-span-1 px-3 py-2 flex justify-end">
              <button class="del-btn rounded-lg border px-2 py-1 text-xs hover:bg-rose-50 border-rose-200 text-rose-700" data-real="${c._i}">
                Delete
              </button>
            </div>
          </div>
        `).join('')}
      `;

      target.innerHTML = '';
      target.appendChild(table);

      // Wire delete with real index in full list
      $$('.del-btn', target).forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const real = Number(btn.dataset.real);
          const all = store.read(KEYS.classes, []);
          if (real>=0 && real<all.length) {
            all.splice(real,1);
            store.write(KEYS.classes, all);
            loadTeacherView();
            loadStudentView();
          }
        });
      });
    }

    // ---------- SMS ----------
    function classesToSms({grade, strand, section}, classes){
      const s = store.read(KEYS.settings, {schoolName:'', smsSender:'SchedMaster'});
      const school = s.schoolName ? `${s.schoolName}\n` : '';
      const header = `${school}Good day! Weekly schedule for G${grade} ${strand}-${section}:\n\n`;

      // group by day and sort
      const byDay = Object.fromEntries(DAYS.map(d=>[d, []]));
      classes.forEach(c=>byDay[c.day].push(c));
      DAYS.forEach(d=>byDay[d].sort((a,b)=>timeToMinutes(a.start)-timeToMinutes(b.start)));

      const body = DAYS.map(d=>{
        if(byDay[d].length===0) return `${d}: No classes`;
        const lines = byDay[d].map(c=>{
          const room = c.room ? ` (Rm ${c.room})` : '';
          return `- ${to12Hour(c.start)}â€“${to12Hour(c.end)} ${c.subject}${room}`;
        }).join('\n');
        return `${d}:\n${lines}`;
      }).join('\n');

      return `${header}${body}\n\n- ${s.smsSender}`;
    }

    function renderSubsList(){
      const list = store.read(KEYS.subs, []);
      const host = $('#subs-list');
      host.innerHTML='';
      if(list.length===0){
        host.innerHTML = '<p class="text-sm text-slate-500">No subscribers yet.</p>';
        return;
      }
      list.forEach((sub, i)=>{
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between border rounded-xl px-3 py-2';
        row.innerHTML = `
          <div class='text-sm'>ðŸ“± <span class='font-medium'>${sub.phone}</span> â€” G${sub.grade} ${sub.strand}-${sub.section}</div>
          <button data-i='${i}' class='unsub text-rose-600 hover:underline text-sm'>Remove</button>`;
        host.appendChild(row);
      });
      $$('.unsub', host).forEach(btn=>btn.addEventListener('click', ()=>{
        const list = store.read(KEYS.subs, []);
        list.splice(Number(btn.dataset.i),1);
        store.write(KEYS.subs, list);
        renderSubsList();
      }));
    }

    // ---------- Tabs ----------
    function activateTab(name){
      $$('.tab-panel').forEach(p=>p.classList.toggle('hidden', p.getAttribute('data-panel')!==name));
      $$('.tab-btn').forEach(b=>{
        const active = b.getAttribute('data-tab')===name;
        b.classList.toggle('bg-green-900', active);
        b.classList.toggle('text-white', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      $('#mobileNav').classList.add('hidden');
      localStorage.setItem('sm.activeTab', name);
    }

    // ---------- Loaders ----------
    function loadStudentView(){
      const filter = {
        grade: $('#sv-grade').value,
        strand: $('#sv-strand').value.trim().toUpperCase(),
        section: $('#sv-section').value.trim().toUpperCase()
      };
      const list = fetchClasses(filter);
      renderGrid($('#timetable'), list);
    }

    function loadTeacherView(){
      const filter = normalizeCohort({
        grade: $('#tc-grade').value,
        strand: $('#tc-strand').value,
        section: $('#tc-section').value
      });
      const list = fetchClassesWithIndex(filter);
      renderTeacherTable($('#teacher-table'), list, filter);
    }


    // ---------- Events ----------
    window.addEventListener('DOMContentLoaded', () => {
      // menu
      $('#menuBtn').addEventListener('click', ()=> $('#mobileNav').classList.toggle('hidden'));
      $$('.tab-btn').forEach(btn=>btn.addEventListener('click', ()=> activateTab(btn.getAttribute('data-tab'))));
      activateTab(localStorage.getItem('sm.activeTab') || 'student');

      // year
      $('#year').textContent = new Date().getFullYear();

      // student view
      $('#sv-load').addEventListener('click', loadStudentView);
      $('#export-sms').addEventListener('click', ()=>{ 
        const filter = {
          grade: $('#sv-grade').value,
          strand: $('#sv-strand').value.trim().toUpperCase(),
          section: $('#sv-section').value.trim().toUpperCase()
        };
        const list = fetchClasses(filter);
        const txt = classesToSms(filter, list);
        navigator.clipboard?.writeText(txt);
        alert('SMS text copied to clipboard!');
      });

      $('#sv-sub').addEventListener('click', ()=>{
        const phone = $('#sv-phone').value.trim();
        const filter = {
          grade: $('#sv-grade').value,
          strand: $('#sv-strand').value.trim().toUpperCase(),
          section: $('#sv-section').value.trim().toUpperCase()
        };
        if(!/^0\d{10}$/.test(phone)) { $('#sv-sub-msg').textContent = 'Enter a valid PH number (11 digits, starts with 0).'; return; }
        const subs = store.read(KEYS.subs, []);
        if(subs.find(s=> s.phone===phone && cohortKey(s)===cohortKey(filter))){
          $('#sv-sub-msg').textContent='Already subscribed for this cohort.'; return;
        }
        subs.push({ phone, ...filter });
        store.write(KEYS.subs, subs);
        $('#sv-sub-msg').textContent = 'Subscribed! You will receive weekly SMS (simulated in this demo).';
        renderSubsList();
      });

      // teacher console
      $('#tc-load').addEventListener('click', loadTeacherView);

      $('#class-form').addEventListener('submit', (e)=>{
        e.preventDefault();
        const fd = new FormData(e.target);
        const entry = Object.fromEntries(fd.entries());
        entry.grade = String(entry.grade);
        entry.strand = entry.strand.trim().toUpperCase();
        entry.section = entry.section.trim().toUpperCase();
        entry.day = entry.day.trim().slice(0,3); // normalize day

        if(timeToMinutes(entry.end) <= timeToMinutes(entry.start)){
          $('#conflict-msg').textContent = 'End time must be after start time.';
          $('#conflict-msg').className = 'text-sm mt-1 text-rose-600';
          return;
        }
        const conf = conflictFor(entry);
        if(conf){
          $('#conflict-msg').innerHTML = `Conflict with <span class='font-medium'>${conf.subject}</span> on ${conf.day} ${conf.start}â€“${conf.end}.`;
          $('#conflict-msg').className = 'text-sm mt-1 text-amber-600';
          return;
        }
        addClass(entry);
        $('#conflict-msg').textContent = 'Class added.';
        $('#conflict-msg').className = 'text-sm mt-1 text-emerald-600';
        e.target.reset();
        loadTeacherView();
        // keep on Teacher tab
      });

      // SMS center
      renderSubsList();
      $('#sms-generate').addEventListener('click', ()=>{
        const filter = {
          grade: $('#sms-grade').value,
          strand: $('#sms-strand').value.trim().toUpperCase(), 
          section: $('#sms-section').value.trim().toUpperCase() 
        };
        const all = store.read(KEYS.classes, []);
        const filtered = all.filter(c =>
          c.grade === filter.grade &&
          c.strand === filter.strand &&
          c.section === filter.section
        );
        $('#sms-preview').value = classesToSms(filter, filtered);
      });
      $('#sms-send').addEventListener('click', ()=>{
        $('#sms-status').textContent = 'SMS sent (simulation). In production, connect to an SMS gateway API.';
        setTimeout(()=>$('#sms-status').textContent='', 3000);
      });

      // settings
      const s = store.read(KEYS.settings, {});
      $('#school-name').value = s.schoolName || '';
      $('#sms-sender').value = s.smsSender || 'SchedMaster';
      $('#save-settings').addEventListener('click', ()=>{
        store.write(KEYS.settings, {
          schoolName: $('#school-name').value.trim(),
          smsSender: $('#sms-sender').value.trim() || 'SchedMaster'
        });
        alert('Settings saved.');
      });

      $('#seed-demo').addEventListener('click', ()=>{
        const demo = [
          {grade:'11', strand:'STEM', section:'A', day:'Mon', start:'08:00', end:'09:30', subject:'Math', room:'201', teacher:'Mr. Cruz'},
          {grade:'11', strand:'STEM', section:'A', day:'Mon', start:'09:30', end:'11:00', subject:'English', room:'105', teacher:'Ms. Reyes'},
          {grade:'11', strand:'STEM', section:'A', day:'Thu', start:'10:00', end:'11:30', subject:'ICT', room:'Lab 2', teacher:'Mr. Lim'},
          {grade:'11', strand:'STEM', section:'A', day:'Fri', start:'08:00', end:'09:30', subject:'Filipino', room:'103', teacher:'Ms. Dela Cruz'},
          {grade:'11', strand:'ABM', section:'B', day:'Tue', start:'13:00', end:'14:30', subject:'Accounting', room:'302', teacher:'Mr. Santos'}
        ];
        store.write(KEYS.classes, demo);
        alert('Demo classes seeded. Go to Student View or Teacher Console to see them.');
        loadStudentView();
        loadTeacherView();
      });

      $('#clear-data').addEventListener('click', ()=>{
        if (confirm('Clear all demo data?')) {
          store.write(KEYS.classes, []);
          store.write(KEYS.subs, []); 
          store.write(KEYS.settings, {}); 
          alert('All data cleared.');
          renderSubsList();
          loadTeacherView();
          loadStudentView();
        }
      });

      // Initial renders
      loadStudentView(); // populate timetable immediately
    });
  </script>
</body>
</html>
